<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="user"><!-- namespace를 쓰는 이유는 각 Dao마다 getList와 같이 겹치는 행동이 
		있기 때문이다. -->

	<select id="getByNo" parameterType="Long" resultType="uservo">
	<![CDATA[
		select no, name, gender
		from users
		where no=#{no}
	]]>
	</select>

	<select id="getByEmailAndPassword" parameterType="uservo"
		resultType="uservo"><!-- 따라서 id는 중복해도 되지만 namespace는 겹치면 안된다. -->
		<![CDATA[
			SELECT NO, NAME
			FROM USERS
			WHERE EMAIL=#{email}
			AND PASSWORD=PASSWORD(#{password})
		]]>
		<!-- CDATA 쓰는 이유 : lt, gt를 태그로 인식할까봐 -->
	</select>
	
	<select id="isEmailExists" parameterType="String" resultType="Boolean">
	<![CDATA[
		select exists(
				select no
				from users
				where email=#{email})
	]]>
	</select>

	<update id="update" parameterType="uservo">
		<![CDATA[
			UPDATE USERS
				  SET NAME=#{name},
		]]>

		<if test='password != ""'><!-- dynamic query -->
		<![CDATA[
				  		PASSWORD=#{password},
		]]>
		</if>
		<![CDATA[
				  		GENDER=#{gender}
			WHERE NO=#{no}
		]]>
	</update>
	
	<insert id="insert" parameterType="uservo">
	<![CDATA[
		insert into users(no, name, email, password, gender, join_date)	 
		select * from (select null no,
							#{name} name,
							#{email} email,
							password(#{password}) password,
							#{gender} gender,
							now() reg_date) tmp
		where not exists(select email
						from users
						where email=#{email})
	]]>
	</insert>
</mapper>