<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">
	<select id="getList" parameterType="map" resultType="boardvo">
	<![CDATA[
		select article.no, writer_no, name, title, content, hits, date_format(reg_date, '%y-%m-%d %h:%i:%s') reg_date, group_no, order_no, depth
		from article
		left join users on article.writer_no=users.no
		where article.title like #{kwd}
		order by group_no desc, order_no asc
		limit #{limit1},#{limit2}
	]]>
	</select>
	
	<select id="getCount" parameterType="String" resultType="Long">
	<![CDATA[
		select count(*)
		from article
		where article.title like #{kwd}
	]]>
	</select>
	
	<select id="getByNo" parameterType="Long" resultType="boardvo">
	<![CDATA[
		select article.no, writer_no, name, title, content, hits,
					 date_format(reg_date, '%y-%m-%d %h:%i:%s'), group_no, order_no, depth
		from article
		left join users on article.writer_no=users.no
		where article.no=#{no}
	]]>
	</select>
	
	<insert id="insert" parameterType="boardvo">
	<![CDATA[
		insert into article(no, writer_no, title, content, hits, reg_date, group_no, order_no, depth)
		values (null, #{writer_no}, #{title}, #{content}, 0, now(), 
				ifnull ((select distinct max(group_no) from article a), 0) + 1, 1, 0)
	]]>

	</insert>
	
	<insert id="insertReply" parameterType="map">
	<![CDATA[
		insert into article(no, writer_no, title, content, hits, reg_date,group_no, order_no, depth)
		values (null,
				#{writer_no},
				#{title},
				#{content},
				0,
				now(),
				(select group_no
				from article a
				where no = #{parent_no}),
				(select order_no
				from article a
				where no = #{parent_no}) + 1,
				(select depth
				from article a
				where no = #{parent_no}) + 1)
	]]>
	</insert>
	
	<update id="update" parameterType="boardvo">
	<![CDATA[
		update article
		set title=#{title}, content=#{content}
		where no=#{no}
	]]>
	</update>
	
	<update id="updateOrderNo" parameterType="Long">
	<![CDATA[
		update article
		set order_no = order_no + 1
		where order_no > (select order_no
						 	from (select order_no
						 			from article a
						 			where no = ?) a)
		  and group_no = (select group_no
		  					from ( select group_no
		  							 from article a
		  							 where no = ?) b)
	]]>
	</update>
	
	<update id="updateHits" parameterType="Long">
	<![CDATA[
		update article
		set hits=hits+1
		where no=#{no}
	]]>
	</update>
	
	<delete id="delete" parameterType="Long">
	<![CDATA[
		delete from article
		where no=#{no}
	]]>
	</delete>
</mapper>